{% comment %}
  Collection View - Card-based product listing
{% endcomment %}

<div class="collection-view">
  <div class="collection-view__container">
    {% if section.settings.heading != blank %}
      <h2 class="collection-view__title">{{ section.settings.heading }}</h2>
    {% elsif collection %}
      <h2 class="collection-view__title">{{ collection.title }}</h2>
    {% endif %}
    
    <div class="collection-view__grid">
      {% if section.settings.collection != blank %}
        {% assign selected_collection = collections[section.settings.collection] %}
      {% elsif collection %}
        {% assign selected_collection = collection %}
      {% else %}
        {% assign selected_collection = collections['all'] %}
      {% endif %}
      
      {% if selected_collection != blank and selected_collection.products.size > 0 %}
        {% for product in selected_collection.products limit: section.settings.products_to_show %}
          <a href="{{ product.url }}" class="product-card-link">
            <div class="product-card">
              {% if product.featured_image %}
                <img 
                  src="{{ product.featured_image | image_url: width: 600 }}" 
                  alt="{{ product.title | escape }}"
                  loading="lazy"
                />
              {% else %}
                <div class="product-card__placeholder">
                  <svg width="100" height="100" viewBox="0 0 100 100" fill="none">
                    <rect width="100" height="100" fill="#f5f5f5"/>
                  </svg>
                </div>
              {% endif %}
              
              <section>
                <h2>{{ product.title }}</h2>
                
                {% unless product.has_only_default_variant %}
                  <div class="product-card__variants" data-product-id="{{ product.id }}">
                    {% for option in product.options_with_values %}
                      <div class="variant-option">
                        <label class="variant-option__label">{{ option.name }}</label>
                        <div class="variant-option__values">
                          {% for value in option.values %}
                            <input 
                              type="radio" 
                              id="product-{{ product.id }}-option{{ forloop.parentloop.index }}-{{ forloop.index }}"
                              name="product-{{ product.id }}-option-{{ option.name | handleize }}"
                              value="{{ value | escape }}"
                              {% if option.selected_value == value %}checked{% endif %}
                              class="variant-option__input"
                              data-option-name="{{ option.name | escape }}"
                              onclick="event.stopPropagation();"
                            >
                            <label 
                              for="product-{{ product.id }}-option{{ forloop.parentloop.index }}-{{ forloop.index }}"
                              class="variant-option__value"
                              onclick="event.stopPropagation();"
                            >
                              {{ value }}
                            </label>
                          {% endfor %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                  
                  <script type="application/json" data-variants="{{ product.id }}">
                    [
                      {% for variant in product.variants %}
                      {
                        "id": {{ variant.id }},
                        "price": "{{ variant.price | money }}",
                        "available": {{ variant.available | json }},
                        "options": {{ variant.options | json }},
                        "featured_image": {% if variant.featured_image %}"{{ variant.featured_image | image_url: width: 600 }}"{% else %}null{% endif %}
                      }{% unless forloop.last %},{% endunless %}
                      {% endfor %}
                    ]
                  </script>
                {% endunless %}
                
                <div>
                  <div class="tag">
                    <span class="product-price" data-price-for="{{ product.id }}">{{ product.price | money }}</span>
                    {% if product.compare_at_price > product.price %}
                      <span class="tag--sale">{{ product.compare_at_price | money }}</span>
                    {% endif %}
                  </div>
                  <button 
                    class="add-to-cart-btn" 
                    data-product-id="{{ product.selected_or_first_available_variant.id }}"
                    data-product-url="{{ product.url }}"
                    data-card-id="{{ product.id }}"
                    onclick="event.preventDefault(); event.stopPropagation();"
                  >
                    Add to Cart
                  </button>
                </div>
              </section>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <div class="collection-view__empty">
          <p>No products found in this collection. Please select a collection with products in the theme editor.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .collection-view {
    padding: 8rem 0;
    background: #f8f8f8;
  }

  .collection-view__container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .collection-view__title {
    font-family: var(--font-heading-family);
    font-size: 4rem;
    font-weight: 300;
    text-align: center;
    margin-bottom: 6rem;
    color: var(--color-primary);
  }

  .collection-view__grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 3rem;
    justify-items: center;
  }

  .product-card-link {
    text-decoration: none;
    color: inherit;
    display: block;
    width: 100%;
    max-width: 20rem;
  }

  .collection-view__empty {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
    color: rgba(0, 0, 0, 0.6);
    font-size: 1.6rem;
  }

  .product-card {
    --bg: #fff;
    --title-color: #fff;
    --title-color-hover: #000;
    --text-color: #666;
    --button-color: #eee;
    --button-color-hover: #ddd;
    background: var(--bg);
    border-radius: 2rem;
    padding: 0.5rem;
    width: 100%;
    height: 30rem;
    overflow: clip;
    position: relative;
    font-family: var(--font-body-family);
    transition: transform 0.3s ease;
  }

  .product-card-link:hover .product-card {
    transform: translateY(-5px);
  }

  .product-card::before {
    content: "";
    position: absolute;
    width: calc(100% - 1rem);
    height: 30%;
    bottom: 0.5rem;
    left: 0.5rem;
    mask: linear-gradient(#0000, #000f 80%);
    backdrop-filter: blur(1rem);
    border-radius: 0 0 1.5rem 1.5rem;
    translate: 0 0;
    transition: translate 0.25s;
    z-index: 1;
  }

  .product-card > img,
  .product-card__placeholder {
    max-width: 100%;
    aspect-ratio: 2 / 3;
    object-fit: cover;
    object-position: 50% 5%;
    border-radius: 1.5rem;
    display: block;
    transition: aspect-ratio 0.25s, object-position 0.5s;
    width: 100%;
    height: auto;
  }

  .product-card__placeholder {
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-card > section {
    margin: 1rem;
    height: calc(33.3333% - 1rem);
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 2;
  }

  .product-card > section h2 {
    margin: 0;
    margin-block-end: 0.5rem;
    font-size: 1.5rem;
    opacity: 0;
    translate: 0 -200%;
    color: var(--title-color);
    transition: color 0.5s, margin-block-end 0.25s, opacity 1s, translate 0.25s;
    font-family: var(--font-heading-family);
    font-weight: 400;
  }

  .product-card__variants {
    margin: 0.5rem 0;
    opacity: 0;
    translate: 0 -100%;
    transition: opacity 1s 0.1s, translate 0.25s 0.1s;
  }

  .variant-option {
    margin-bottom: 0.5rem;
  }

  .variant-option__label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 0.3rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .variant-option__values {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
  }

  .variant-option__input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .variant-option__value {
    padding: 0.4rem 0.8rem;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 0.5rem;
    font-size: 0.8rem;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.9);
    color: var(--title-color-hover);
    transition: all 0.2s ease;
    font-weight: 500;
    white-space: nowrap;
  }

  .variant-option__input:checked + .variant-option__value {
    background: var(--title-color-hover);
    color: #ffffff;
    border-color: var(--title-color-hover);
  }

  .variant-option__value:hover {
    border-color: var(--title-color-hover);
    transform: translateY(-1px);
  }


  .product-card > section > div {
    flex: 1;
    align-items: flex-end;
    display: flex;
    justify-content: space-between;
    translate: 0 100%;
    opacity: 0;
    transition: translate 0.25s 0.2s, opacity 1s;
  }

  .product-card > section > div .tag {
    align-self: center;
    color: var(--title-color-hover);
    font-weight: 600;
    font-size: 1.2rem;
  }

  .product-card > section > div .tag--sale {
    text-decoration: line-through;
    opacity: 0.6;
    font-size: 1rem;
    margin-left: 0.5rem;
  }

  .product-card > section > div button {
    border: 1px solid transparent;
    border-radius: 1.25rem 1.25rem 1.5rem 1.25rem;
    font-size: 1rem;
    padding: 1rem 1.5rem 1rem 2.75rem;
    translate: 1rem;
    background: var(--button-color);
    transition: background 0.33s;
    outline-offset: 2px;
    position: relative;
    color: var(--title-color-hover);
    cursor: pointer;
    font-family: var(--font-body-family);
    font-weight: 500;
  }

  .product-card > section > div button::before,
  .product-card > section > div button::after {
    content: "";
    width: 0.85rem;
    height: 0.1rem;
    background: currentcolor;
    position: absolute;
    top: 50%;
    left: 1.33rem;
    border-radius: 1rem;
  }

  .product-card > section > div button::after {
    rotate: 90deg;
    transition: rotate 0.15s;
  }

  .product-card > section > div button:hover {
    background: var(--button-color-hover);
  }

  .product-card > section > div button:focus {
    outline: 2px solid var(--text-color);
  }

  .product-card > section > div button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .product-card > img {
    transition: opacity 0.3s ease, aspect-ratio 0.25s, object-position 0.5s;
  }

  .product-card-link:hover .product-card > img,
  .product-card-link:focus-within .product-card > img {
    aspect-ratio: 1 / 1;
    object-position: 50% 10%;
    transition: aspect-ratio 0.25s, object-position 0.25s;
  }

  .product-card-link:hover .product-card::before,
  .product-card-link:focus-within .product-card::before {
    translate: 0 100%;
  }

  .product-card-link:hover .product-card > section h2,
  .product-card-link:focus-within .product-card > section h2 {
    translate: 0 0;
    margin-block-end: 0.5rem;
    opacity: 1;
    color: var(--title-color-hover);
  }

  .product-card-link:hover .product-card__variants,
  .product-card-link:focus-within .product-card__variants {
    translate: 0 0;
    opacity: 1;
  }

  .product-card-link:hover .product-card > section > div,
  .product-card-link:focus-within .product-card > section > div {
    translate: 0 0;
    opacity: 1;
    transition: translate 0.25s 0.25s, opacity 0.5s 0.25s;
  }

  @media (max-width: 768px) {
    .collection-view {
      padding: 4rem 0;
    }

    .collection-view__title {
      font-size: 3rem;
      margin-bottom: 4rem;
    }

    .collection-view__grid {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .product-card {
      max-width: 100%;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle variant selection
    const variantInputs = document.querySelectorAll('.variant-option__input');
    
    variantInputs.forEach(input => {
      input.addEventListener('change', function(e) {
        e.stopPropagation();
        const productId = this.closest('.product-card__variants').dataset.productId;
        const card = this.closest('.product-card-link');
        
        // Get all selected options for this product
        const selectedOptions = {};
        const allInputs = card.querySelectorAll('.variant-option__input');
        allInputs.forEach(inp => {
          if (inp.checked) {
            const optionName = inp.dataset.optionName;
            selectedOptions[optionName] = inp.value;
          }
        });
        
        // Get variant data from JSON script
        const variantScript = card.querySelector(`script[data-variants="${productId}"]`);
        if (!variantScript) return;
        
        const variants = JSON.parse(variantScript.textContent);
        const optionNames = Object.keys(selectedOptions);
        
        // Find matching variant
        const matchingVariant = variants.find(variant => {
          return variant.options.every((option, index) => {
            const optionName = optionNames[index];
            return selectedOptions[optionName] === option;
          });
        });
        
        if (matchingVariant) {
          // Update add to cart button
          const button = card.querySelector('.add-to-cart-btn');
          button.dataset.productId = matchingVariant.id;
          
          // Update price
          const priceElement = card.querySelector(`.product-price[data-price-for="${productId}"]`);
          if (priceElement) {
            priceElement.textContent = matchingVariant.price;
          }
          
          // Update button availability
          if (matchingVariant.available) {
            button.disabled = false;
            button.textContent = 'Add to Cart';
          } else {
            button.disabled = true;
            button.textContent = 'Sold Out';
          }
          
          // Update image if variant has one
          if (matchingVariant.featured_image) {
            const productImage = card.querySelector('.product-card > img');
            if (productImage) {
              productImage.style.opacity = '0.7';
              setTimeout(() => {
                productImage.src = matchingVariant.featured_image;
                productImage.style.opacity = '1';
              }, 200);
            }
          }
        }
      });
    });
    
    // Handle add to cart
    const buttons = document.querySelectorAll('.add-to-cart-btn');
    
    buttons.forEach(button => {
      button.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const productId = this.dataset.productId;
        const productUrl = this.dataset.productUrl;
        
        if (!productId || this.disabled) {
          if (!this.disabled) {
            window.location.href = productUrl;
          }
          return;
        }

        const formData = {
          'items': [{
            'id': parseInt(productId),
            'quantity': 1
          }]
        };

        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
          });

          if (response.ok) {
            const button = this;
            const originalText = button.textContent;
            button.textContent = 'Added!';
            button.style.background = '#4caf50';
            
            // Reload cart count
            fetch('/cart.js')
              .then(response => response.json())
              .then(cart => {
                const cartCount = document.querySelector('.header__cart-count');
                if (cartCount) {
                  cartCount.textContent = cart.item_count;
                }
              });
            
            setTimeout(() => {
              button.textContent = originalText;
              button.style.background = '';
            }, 2000);
          } else {
            window.location.href = productUrl;
          }
        } catch (error) {
          console.error('Error adding to cart:', error);
          window.location.href = productUrl;
        }
      });
    });
  });
</script>

{% schema %}
{
  "name": "Collection View",
  "tag": "section",
  "class": "section-collection-view",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Shop Collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to show",
      "min": 4,
      "max": 24,
      "step": 1,
      "default": 12
    }
  ],
  "presets": [
    {
      "name": "Collection View"
    }
  ]
}
{% endschema %}

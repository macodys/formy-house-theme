{% comment %}
  Predictive Search - Live autocomplete suggestions
{% endcomment %}

<div class="predictive-search" id="predictive-search">
  <div class="predictive-search__results" id="predictive-search-results" style="display: none;">
    <!-- Results will be populated by JavaScript -->
  </div>
</div>

<style>
  .predictive-search {
    position: relative;
  }

  .predictive-search__results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 0.5rem;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    max-height: 500px;
    overflow-y: auto;
    z-index: 1000;
  }

  .predictive-search__header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  }

  .predictive-search__title {
    font-size: 1.3rem;
    font-weight: 600;
    color: rgba(0, 0, 0, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
  }

  .predictive-search__list {
    list-style: none;
    margin: 0;
    padding: 0.5rem 0;
  }

  .predictive-search__item {
    display: block;
  }

  .predictive-search__link {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1rem 2rem;
    text-decoration: none;
    color: inherit;
    transition: background 0.2s ease;
  }

  .predictive-search__link:hover {
    background: rgba(0, 0, 0, 0.03);
  }

  .predictive-search__image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    background: #f5f5f5;
    flex-shrink: 0;
  }

  .predictive-search__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .predictive-search__details {
    flex: 1;
    min-width: 0;
  }

  .predictive-search__product-title {
    font-size: 1.5rem;
    font-weight: 500;
    color: var(--color-primary);
    margin: 0 0 0.3rem 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .predictive-search__price {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--color-accent);
  }

  .predictive-search__empty {
    padding: 3rem 2rem;
    text-align: center;
    color: rgba(0, 0, 0, 0.5);
  }

  .predictive-search__empty-text {
    font-size: 1.5rem;
    margin: 0;
  }

  .predictive-search__view-all {
    display: block;
    padding: 1.5rem 2rem;
    text-align: center;
    font-weight: 600;
    color: var(--color-accent);
    text-decoration: none;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
    transition: background 0.2s ease;
  }

  .predictive-search__view-all:hover {
    background: rgba(0, 0, 0, 0.03);
  }

  .predictive-search__loading {
    padding: 3rem 2rem;
    text-align: center;
    color: rgba(0, 0, 0, 0.5);
  }

  .predictive-search__spinner {
    width: 30px;
    height: 30px;
    border: 3px solid rgba(0, 0, 0, 0.1);
    border-top-color: var(--color-accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInputs = document.querySelectorAll('.header__search-input');
    const searchForms = document.querySelectorAll('.header__search-form');
    let searchTimeout;
    let currentQuery = '';
    
    searchInputs.forEach((searchInput, index) => {
      const searchForm = searchForms[index];
      
      // Create predictive search container
      const predictiveSearch = document.createElement('div');
      predictiveSearch.className = 'predictive-search__results';
      predictiveSearch.style.display = 'none';
      
      // Position it relative to the search form
      searchForm.style.position = 'relative';
      searchForm.appendChild(predictiveSearch);
      
      // Handle input
      searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
          hidePredictiveSearch(predictiveSearch);
          return;
        }
        
        currentQuery = query;
        
        // Show loading state
        showLoadingState(predictiveSearch);
        
        // Debounce the search
        searchTimeout = setTimeout(() => {
          performSearch(query, predictiveSearch);
        }, 300);
      });
      
      // Handle focus
      searchInput.addEventListener('focus', function() {
        if (currentQuery.length >= 2) {
          predictiveSearch.style.display = 'block';
        }
      });
      
      // Hide on escape
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          hidePredictiveSearch(predictiveSearch);
          searchInput.blur();
        }
      });
    });
    
    // Close predictive search when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.header__search-form')) {
        document.querySelectorAll('.predictive-search__results').forEach(el => {
          el.style.display = 'none';
        });
      }
    });
    
    function showLoadingState(container) {
      container.innerHTML = `
        <div class="predictive-search__loading">
          <div class="predictive-search__spinner"></div>
        </div>
      `;
      container.style.display = 'block';
    }
    
    function hidePredictiveSearch(container) {
      container.style.display = 'none';
      container.innerHTML = '';
    }
    
    async function performSearch(query, container) {
      try {
        const response = await fetch(`/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=6`);
        const data = await response.json();
        
        displayResults(data, query, container);
      } catch (error) {
        console.error('Search error:', error);
        container.innerHTML = `
          <div class="predictive-search__empty">
            <p class="predictive-search__empty-text">Unable to load results</p>
          </div>
        `;
      }
    }
    
    function displayResults(data, query, container) {
      const products = data.resources.results.products || [];
      
      if (products.length === 0) {
        container.innerHTML = `
          <div class="predictive-search__empty">
            <p class="predictive-search__empty-text">No products found</p>
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="predictive-search__header">
          <h3 class="predictive-search__title">Products</h3>
        </div>
        <ul class="predictive-search__list">
      `;
      
      products.forEach(product => {
        const imageUrl = product.image ? product.image : '';
        const price = formatMoney(product.price);
        
        html += `
          <li class="predictive-search__item">
            <a href="${product.url}" class="predictive-search__link">
              <div class="predictive-search__image">
                ${imageUrl ? `<img src="${imageUrl}" alt="${escapeHtml(product.title)}">` : ''}
              </div>
              <div class="predictive-search__details">
                <h4 class="predictive-search__product-title">${escapeHtml(product.title)}</h4>
                <p class="predictive-search__price">${price}</p>
              </div>
            </a>
          </li>
        `;
      });
      
      html += `
        </ul>
        <a href="/search?q=${encodeURIComponent(query)}" class="predictive-search__view-all">
          View all results for "${escapeHtml(query)}"
        </a>
      `;
      
      container.innerHTML = html;
      container.style.display = 'block';
    }
    
    function formatMoney(cents) {
      const amount = cents / 100;
      return amount.toLocaleString('{{ request.locale.iso_code }}', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code }}'
      });
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  });
</script>


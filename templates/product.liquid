{% comment %}
  Product Template - Professional product page with variants and gallery
{% endcomment %}

{% if product %}
<div class="product-page">
  <div class="product-page__container">
    <div class="product-page__gallery">
      <div class="product-gallery">
        <div class="product-gallery__main">
          {% if product.featured_image %}
            <img 
              id="ProductImage"
              src="{{ product.featured_image | image_url: width: 1200 }}" 
              alt="{{ product.title | escape }}"
              class="product-gallery__main-image"
            />
          {% else %}
            <div class="product-gallery__placeholder">
              <svg width="400" height="400" viewBox="0 0 400 400" fill="none">
                <rect width="400" height="400" fill="#f5f5f5"/>
              </svg>
            </div>
          {% endif %}
        </div>
        
        {% if product.images.size > 1 %}
          <div class="product-gallery__thumbnails">
            {% for image in product.images %}
              <button 
                class="product-gallery__thumbnail {% if forloop.first %}active{% endif %}"
                data-image-src="{{ image | image_url: width: 1200 }}"
                aria-label="View product image {{ forloop.index }}"
              >
                <img 
                  src="{{ image | image_url: width: 200 }}" 
                  alt="{{ product.title | escape }} - Image {{ forloop.index }}"
                  loading="lazy"
                />
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    
    <div class="product-page__info">
      <div class="product-info">
        <h1 class="product-info__title">{{ product.title }}</h1>
        
        <div class="product-info__price">
          <span class="product-info__price-current">{{ product.selected_or_first_available_variant.price | money }}</span>
          {% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}
            <span class="product-info__price-compare">{{ product.selected_or_first_available_variant.compare_at_price | money }}</span>
            <span class="product-info__price-save">Save {{ product.selected_or_first_available_variant.compare_at_price | minus: product.selected_or_first_available_variant.price | money }}</span>
          {% endif %}
        </div>
        
        <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form" id="ProductForm">
          <div class="product-form__options-container">
            {% unless product.has_only_default_variant %}
              <div class="product-form__variants">
                {% for option in product.options_with_values %}
                  <div class="product-form__option">
                    <div class="product-form__option-label">
                      {{ option.name }}
                    </div>
                    <div class="product-form__option-values">
                      {% for value in option.values %}
                        <input 
                          type="radio" 
                          id="Option{{ forloop.parentloop.index }}-{{ forloop.index }}"
                          name="options[{{ option.name | escape }}]"
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}checked{% endif %}
                          class="product-form__option-input"
                        >
                        <label 
                          for="Option{{ forloop.parentloop.index }}-{{ forloop.index }}"
                          class="product-form__option-value"
                        >
                          {{ value }}
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endunless %}
            
            <div class="product-form__quantity">
              <label for="Quantity" class="product-form__quantity-label">Quantity</label>
              <div class="product-form__quantity-controls">
                <button type="button" class="product-form__quantity-btn" data-action="decrease">−</button>
                <input 
                  type="number" 
                  id="Quantity" 
                  name="quantity" 
                  value="1" 
                  min="1"
                  class="product-form__quantity-input"
                >
                <button type="button" class="product-form__quantity-btn" data-action="increase">+</button>
              </div>
            </div>
          </div>
          
          <input type="hidden" name="id" id="ProductVariantId" value="{{ product.selected_or_first_available_variant.id }}">
          
          <button 
            type="submit" 
            name="add" 
            class="product-form__submit"
            {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
          >
            {% if product.selected_or_first_available_variant.available %}
              Add to Cart
            {% else %}
              Sold Out
            {% endif %}
          </button>
        </form>
        
        {% if product.description != blank %}
          <div class="product-info__description">
            {{ product.description }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% else %}
  <div class="product-page">
    <div class="product-page__container">
      <p>Product not found.</p>
    </div>
  </div>
{% endif %}

<style>
  .product-page {
    padding: 6rem 0;
    background: #ffffff;
  }

  .product-page__container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
    display: grid;
    grid-template-columns: 0.7fr 1.3fr;
    gap: 6rem;
    align-items: start;
  }

  .product-gallery {
    position: sticky;
    top: 100px;
  }

  .product-gallery__main {
    width: 100%;
    margin-bottom: 2rem;
    border-radius: 12px;
    overflow: hidden;
    background: #f8f8f8;
  }

  .product-gallery__main-image {
    width: 100%;
    height: auto;
    display: block;
    transition: opacity 0.3s ease;
  }

  .product-gallery__placeholder {
    width: 100%;
    aspect-ratio: 1 / 1;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-gallery__thumbnails {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .product-gallery__thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    background: none;
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
  }

  .product-gallery__thumbnail:hover {
    border-color: var(--color-accent);
    transform: scale(1.05);
  }

  .product-gallery__thumbnail.active {
    border-color: var(--color-primary);
  }

  .product-gallery__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .product-info__title {
    font-family: var(--font-heading-family);
    font-size: 4rem;
    font-weight: 300;
    margin: 0 0 2.5rem 0;
    color: var(--color-primary, #1a1a1a);
    line-height: 1.15;
    letter-spacing: -0.03em;
    position: relative;
    padding-bottom: 1.5rem;
  }

  .product-info__title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 2px;
    background: linear-gradient(90deg, var(--color-accent, #1a1a1a) 0%, transparent 100%);
    border-radius: 2px;
  }

  .product-info__price {
    margin-bottom: 3.5rem;
    padding: 2rem 2.5rem;
    background: linear-gradient(135deg, rgba(248, 248, 248, 0.6) 0%, rgba(255, 255, 255, 0.8) 100%);
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.06);
    display: flex;
    align-items: baseline;
    gap: 1.5rem;
    flex-wrap: wrap;
    position: relative;
    overflow: hidden;
  }

  .product-info__price::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(180deg, var(--color-accent, #1a1a1a) 0%, rgba(26, 26, 26, 0.4) 100%);
    border-radius: 0 2px 2px 0;
  }

  .product-info__price-current {
    font-size: 3.2rem;
    font-weight: 700;
    color: var(--color-accent, #1a1a1a);
    letter-spacing: -0.02em;
    position: relative;
  }

  .product-info__price-compare {
    font-size: 2rem;
    color: rgba(0, 0, 0, 0.45);
    text-decoration: line-through;
    font-weight: 400;
    position: relative;
  }

  .product-info__price-save {
    font-size: 1.4rem;
    color: #2e7d32;
    font-weight: 600;
    padding: 0.4rem 1rem;
    background: rgba(46, 125, 50, 0.1);
    border-radius: 6px;
    letter-spacing: 0.02em;
  }

  .product-info__description {
    margin-bottom: 4rem;
    margin-top: 2rem;
    padding: 3rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 248, 248, 0.9) 100%);
    border-radius: 16px;
    border: 1px solid rgba(0, 0, 0, 0.06);
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.04);
    font-size: 1.7rem;
    line-height: 1.85;
    color: rgba(0, 0, 0, 0.75);
    letter-spacing: 0.01em;
    position: relative;
    overflow: hidden;
  }

  .product-info__description::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, var(--color-accent, #1a1a1a) 0%, rgba(26, 26, 26, 0.3) 100%);
    border-radius: 2px 0 0 2px;
  }

  .product-info__description > *:first-child {
    margin-top: 0;
  }

  .product-info__description > *:last-child {
    margin-bottom: 0;
  }

  .product-info__description p {
    margin-bottom: 1.5rem;
    font-weight: 300;
  }

  .product-info__description h1,
  .product-info__description h2,
  .product-info__description h3,
  .product-info__description h4 {
    font-family: var(--font-heading-family);
    margin-top: 2.5rem;
    margin-bottom: 1.2rem;
    font-weight: 400;
    color: var(--color-primary, #1a1a1a);
    letter-spacing: -0.02em;
  }

  .product-info__description h1 {
    font-size: 2.4rem;
  }

  .product-info__description h2 {
    font-size: 2rem;
  }

  .product-info__description h3 {
    font-size: 1.8rem;
  }

  .product-info__description h4 {
    font-size: 1.6rem;
  }

  .product-info__description ul,
  .product-info__description ol {
    margin: 1.5rem 0;
    padding-left: 2.5rem;
    list-style-position: outside;
  }

  .product-info__description ul {
    list-style-type: none;
  }

  .product-info__description ul li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.8rem;
  }

  .product-info__description ul li::before {
    content: '▸';
    position: absolute;
    left: 0;
    color: var(--color-accent, #1a1a1a);
    font-size: 1.2rem;
    line-height: 1.5;
  }

  .product-info__description ol {
    list-style-type: decimal;
  }

  .product-info__description ol li {
    margin-bottom: 0.8rem;
  }

  .product-info__description a {
    color: var(--color-accent, #1a1a1a);
    text-decoration: none;
    border-bottom: 1px solid rgba(26, 26, 26, 0.2);
    transition: all 0.3s ease;
  }

  .product-info__description a:hover {
    border-bottom-color: var(--color-accent, #1a1a1a);
    color: var(--color-primary, #1a1a1a);
  }

  .product-info__description strong,
  .product-info__description b {
    font-weight: 600;
    color: var(--color-primary, #1a1a1a);
  }

  .product-info__description em,
  .product-info__description i {
    font-style: italic;
    color: rgba(0, 0, 0, 0.8);
  }

  .product-info__description blockquote {
    margin: 2rem 0;
    padding: 1.5rem 2rem;
    border-left: 3px solid var(--color-accent, #1a1a1a);
    background: rgba(0, 0, 0, 0.02);
    border-radius: 0 8px 8px 0;
    font-style: italic;
    color: rgba(0, 0, 0, 0.8);
  }

  .product-info__description hr {
    border: none;
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, rgba(0, 0, 0, 0.1) 50%, transparent 100%);
    margin: 2.5rem 0;
  }

  .product-form {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  .product-form__options-container {
    padding: 2.5rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(250, 250, 250, 0.95) 100%);
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.08);
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.03);
    position: relative;
    overflow: hidden;
  }

  .product-form__options-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    background: linear-gradient(180deg, var(--color-accent, #1a1a1a) 0%, rgba(26, 26, 26, 0.3) 100%);
    border-radius: 0 2px 2px 0;
  }

  .product-form__variants {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .product-form__option {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }

  .product-form__option-label {
    font-size: 1.7rem;
    font-weight: 600;
    color: var(--color-primary, #1a1a1a);
    letter-spacing: -0.01em;
    margin-bottom: 0.5rem;
  }

  .product-form__option-values {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
  }

  .product-form__option-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .product-form__option-value {
    padding: 1.2rem 2.2rem;
    border: 2px solid rgba(0, 0, 0, 0.12);
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.5rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: #ffffff;
    display: inline-block;
    position: relative;
    font-weight: 500;
    letter-spacing: 0.01em;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .product-form__option-input:checked + .product-form__option-value,
  .product-form__option-value.selected {
    border-color: #1a1a1a;
    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
    color: #ffffff;
    font-weight: 600;
    box-shadow: 0 4px 16px rgba(26, 26, 26, 0.25), 0 0 0 3px rgba(26, 26, 26, 0.08);
    transform: translateY(-2px);
  }

  .product-form__option-value:hover:not(.selected) {
    border-color: rgba(26, 26, 26, 0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .product-form__quantity {
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    margin-top: 2.5rem;
    padding-top: 2.5rem;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
  }

  .product-form__quantity-label {
    font-size: 1.7rem;
    font-weight: 600;
    color: var(--color-primary, #1a1a1a);
    letter-spacing: -0.01em;
    margin-bottom: 0.5rem;
  }

  .product-form__quantity-controls {
    display: flex;
    align-items: center;
    gap: 1.2rem;
    width: fit-content;
    margin-top: 0.5rem;
  }

  .product-form__quantity-btn {
    width: 44px;
    height: 44px;
    border: 2px solid rgba(0, 0, 0, 0.12);
    background: #ffffff;
    border-radius: 10px;
    font-size: 2rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary, #1a1a1a);
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .product-form__quantity-btn:hover {
    border-color: #1a1a1a;
    background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
    color: #ffffff;
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(26, 26, 26, 0.2);
  }

  .product-form__quantity-btn:active {
    transform: translateY(0);
  }

  .product-form__quantity-input {
    width: 90px;
    height: 44px;
    border: 2px solid rgba(0, 0, 0, 0.12);
    border-radius: 10px;
    text-align: center;
    font-size: 1.7rem;
    font-weight: 600;
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    transition: all 0.3s ease;
    color: var(--color-primary, #1a1a1a);
  }

  .product-form__quantity-input:focus {
    outline: none;
    border-color: var(--color-accent, #1a1a1a);
    box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
  }

  .product-form__submit {
    padding: 1.8rem 3.2rem;
    background: var(--color-accent);
    color: #ffffff;
    border: none;
    border-radius: 12px;
    font-size: 1.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: var(--font-body-family);
  }

  .product-form__submit:hover:not(:disabled) {
    background: var(--color-primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .product-form__submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (max-width: 990px) {
    .product-page {
      padding: 4rem 0;
    }

    .product-page__container {
      grid-template-columns: 1fr;
      gap: 4rem;
    }

    .product-gallery {
      position: static;
    }

    .product-info__title {
      font-size: 3rem;
      padding-bottom: 1.2rem;
    }

    .product-info__title::after {
      width: 50px;
    }

    .product-info__price {
      padding: 1.5rem 2rem;
    }

    .product-info__price-current {
      font-size: 2.6rem;
    }

    .product-info__price-compare {
      font-size: 1.8rem;
    }

    .product-info__price-save {
      font-size: 1.3rem;
      padding: 0.3rem 0.8rem;
    }

    .product-info__description {
      padding: 2rem;
      font-size: 1.6rem;
      margin-top: 1.5rem;
    }

    .product-info__description h1 {
      font-size: 2rem;
    }

    .product-info__description h2 {
      font-size: 1.8rem;
    }

    .product-info__description h3 {
      font-size: 1.6rem;
    }

    .product-info__description h4 {
      font-size: 1.5rem;
    }

    .product-form__options-container {
      padding: 2rem;
    }

    .product-form__option-label {
      font-size: 1.6rem;
    }

    .product-form__option-value {
      padding: 1rem 1.8rem;
      font-size: 1.4rem;
    }

    .product-form__quantity {
      margin-top: 2rem;
      padding-top: 2rem;
    }

    .product-form__quantity-label {
      font-size: 1.6rem;
    }

    .product-form__quantity-btn {
      width: 40px;
      height: 40px;
      font-size: 1.8rem;
    }

    .product-form__quantity-input {
      width: 80px;
      height: 40px;
      font-size: 1.6rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Image gallery functionality
    const thumbnails = document.querySelectorAll('.product-gallery__thumbnail');
    const mainImage = document.getElementById('ProductImage');
    
    if (thumbnails.length > 0 && mainImage) {
      thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
          // Update main image
          const newSrc = this.dataset.imageSrc;
          mainImage.src = newSrc;
          
          // Update active state
          thumbnails.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }

    // Quantity controls
    const quantityInput = document.getElementById('Quantity');
    const decreaseBtn = document.querySelector('[data-action="decrease"]');
    const increaseBtn = document.querySelector('[data-action="increase"]');
    
    if (decreaseBtn) {
      decreaseBtn.addEventListener('click', function() {
        const current = parseInt(quantityInput.value);
        if (current > 1) {
          quantityInput.value = current - 1;
        }
      });
    }
    
    if (increaseBtn) {
      increaseBtn.addEventListener('click', function() {
        const current = parseInt(quantityInput.value);
        quantityInput.value = current + 1;
      });
    }

    // Variant selection
    const variantInputs = document.querySelectorAll('.product-form__option-input');
    const variantIdInput = document.getElementById('ProductVariantId');
    
    if (variantInputs.length > 0) {
      // Update all labels when any variant changes
      function updateVariantLabels() {
        variantInputs.forEach(input => {
          const label = input.nextElementSibling;
          if (label) {
            if (input.checked) {
              console.log('Adding selected to:', input.value);
              label.classList.add('selected');
            } else {
              console.log('Removing selected from:', input.value);
              label.classList.remove('selected');
            }
          }
        });
      }
      
      // Set initial state
      updateVariantLabels();
      
      // Update variant on page load to ensure image matches selected variant
      updateVariant();
      
      variantInputs.forEach(input => {
        input.addEventListener('change', function() {
          console.log('Variant clicked:', this.value, 'Checked:', this.checked);
          updateVariantLabels();
          updateVariant();
        });
      });
    }

    let isInitialLoad = true;
    
    function updateVariant() {
      const selectedOptions = {};
      variantInputs.forEach(input => {
        if (input.checked) {
          const optionName = input.name.match(/\[(.*?)\]/)[1];
          selectedOptions[optionName] = input.value;
        }
      });

      // Find matching variant using variant data
      const variantData = [
        {% for variant in product.variants %}
        {
          id: {{ variant.id }},
          price: {{ variant.price }},
          priceFormatted: '{{ variant.price | money }}',
          compare_at_price: {{ variant.compare_at_price | default: 0 }},
          compare_at_priceFormatted: {% if variant.compare_at_price %}'{{ variant.compare_at_price | money }}'{% else %}null{% endif %},
          available: {{ variant.available | json }},
          options: {{ variant.options | json }},
          featured_image: {% if variant.featured_image %}'{{ variant.featured_image | image_url: width: 1200 }}'{% else %}null{% endif %},
          image: {% if variant.image %}'{{ variant.image | image_url: width: 1200 }}'{% else %}null{% endif %}
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ];
      
      // Product images array for fallback
      const productImages = [
        {% for image in product.images %}
        '{{ image | image_url: width: 1200 }}'{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ];

      const optionNames = [
        {% for option in product.options_with_values %}
        '{{ option.name }}'{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ];

      const matchingVariant = variantData.find(variant => {
        return variant.options.every((option, index) => {
          const optionName = optionNames[index];
          return selectedOptions[optionName] === option;
        });
      });

      if (matchingVariant) {
        console.log('Found variant:', matchingVariant.id, 'Image:', matchingVariant.featured_image || matchingVariant.image);
        variantIdInput.value = matchingVariant.id;
        
        // Update price using pre-formatted values
        const priceElement = document.querySelector('.product-info__price-current');
        if (priceElement && matchingVariant.priceFormatted) {
          priceElement.textContent = matchingVariant.priceFormatted;
        }

        // Update compare at price
        const priceCompare = document.querySelector('.product-info__price-compare');
        const priceSave = document.querySelector('.product-info__price-save');
        
        if (matchingVariant.compare_at_price > matchingVariant.price && matchingVariant.compare_at_priceFormatted) {
          if (priceCompare) {
            priceCompare.textContent = matchingVariant.compare_at_priceFormatted;
            priceCompare.style.display = 'inline';
          }
          if (priceSave) {
            const savings = matchingVariant.compare_at_price - matchingVariant.price;
            const savingsFormatted = (savings / 100).toLocaleString('{{ request.locale.iso_code }}', {
              style: 'currency',
              currency: '{{ cart.currency.iso_code }}',
              minimumFractionDigits: 2
            });
            priceSave.textContent = 'Save ' + savingsFormatted;
            priceSave.style.display = 'inline';
          }
        } else {
          if (priceCompare) priceCompare.style.display = 'none';
          if (priceSave) priceSave.style.display = 'none';
        }

        // Update availability
        const submitBtn = document.querySelector('.product-form__submit');
        if (submitBtn) {
          if (matchingVariant.available) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add to Cart';
          } else {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sold Out';
          }
        }

        // Update image when variant changes
        if (mainImage) {
          // Determine which image to show: variant featured_image > variant image > first product image
          let imageToShow = matchingVariant.featured_image || matchingVariant.image;
          
          // If no variant-specific image, use the first product image as fallback
          if (!imageToShow && productImages.length > 0) {
            imageToShow = productImages[0];
          }
          
          if (imageToShow) {
            console.log('Updating image to:', imageToShow);
            // Add smooth fade transition (skip on initial load)
            if (!isInitialLoad) {
              mainImage.style.opacity = '0';
              
              setTimeout(() => {
                mainImage.src = imageToShow;
                mainImage.style.opacity = '1';
                console.log('Image updated!');
              }, 200);
            } else {
              mainImage.src = imageToShow;
              isInitialLoad = false;
              console.log('Initial image set');
            }
            
            // Update thumbnail to match if it exists
            const matchingThumbnail = document.querySelector(`[data-image-src="${imageToShow}"]`);
            if (matchingThumbnail) {
              thumbnails.forEach(t => t.classList.remove('active'));
              matchingThumbnail.classList.add('active');
            } else if (thumbnails.length > 0) {
              // If exact match not found, activate first thumbnail
              thumbnails.forEach(t => t.classList.remove('active'));
              if (thumbnails[0]) {
                thumbnails[0].classList.add('active');
              }
            }
          }
          
          if (isInitialLoad) {
            isInitialLoad = false;
          }
        }
      }
    }
  });
</script>

{% comment %}
  Product Template - Professional product page with variants and gallery
{% endcomment %}

{% if product %}
<div class="product-page">
  <div class="product-page__container">
    <div class="product-page__gallery">
      <div class="product-gallery">
        <div class="product-gallery__main">
          {% if product.featured_image %}
            <img 
              id="ProductImage"
              src="{{ product.featured_image | image_url: width: 1200 }}" 
              alt="{{ product.title | escape }}"
              class="product-gallery__main-image"
            />
          {% else %}
            <div class="product-gallery__placeholder">
              <svg width="400" height="400" viewBox="0 0 400 400" fill="none">
                <rect width="400" height="400" fill="#f5f5f5"/>
              </svg>
            </div>
          {% endif %}
        </div>
        
        {% if product.images.size > 1 %}
          <div class="product-gallery__thumbnails">
            {% for image in product.images %}
              <button 
                class="product-gallery__thumbnail {% if forloop.first %}active{% endif %}"
                data-image-src="{{ image | image_url: width: 1200 }}"
                aria-label="View product image {{ forloop.index }}"
              >
                <img 
                  src="{{ image | image_url: width: 200 }}" 
                  alt="{{ product.title | escape }} - Image {{ forloop.index }}"
                  loading="lazy"
                />
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    
    <div class="product-page__info">
      <div class="product-info">
        <h1 class="product-info__title">{{ product.title }}</h1>
        
        <div class="product-info__price">
          <span class="product-info__price-current">{{ product.selected_or_first_available_variant.price | money }}</span>
          {% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}
            <span class="product-info__price-compare">{{ product.selected_or_first_available_variant.compare_at_price | money }}</span>
            <span class="product-info__price-save">Save {{ product.selected_or_first_available_variant.compare_at_price | minus: product.selected_or_first_available_variant.price | money }}</span>
          {% endif %}
        </div>
        
        <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form" id="ProductForm">
          {% unless product.has_only_default_variant %}
            <div class="product-form__variants">
              {% for option in product.options_with_values %}
                <div class="product-form__option">
                  <label class="product-form__option-label" for="Option{{ forloop.index }}">
                    {{ option.name }}
                  </label>
                  <div class="product-form__option-values">
                    {% for value in option.values %}
                      <input 
                        type="radio" 
                        id="Option{{ forloop.parentloop.index }}-{{ forloop.index }}"
                        name="options[{{ option.name | escape }}]"
                        value="{{ value | escape }}"
                        {% if option.selected_value == value %}checked{% endif %}
                        class="product-form__option-input"
                      >
                      <label 
                        for="Option{{ forloop.parentloop.index }}-{{ forloop.index }}"
                        class="product-form__option-value"
                      >
                        {{ value }}
                      </label>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endunless %}
          
          <div class="product-form__quantity">
            <label for="Quantity" class="product-form__quantity-label">Quantity</label>
            <div class="product-form__quantity-controls">
              <button type="button" class="product-form__quantity-btn" data-action="decrease">âˆ’</button>
              <input 
                type="number" 
                id="Quantity" 
                name="quantity" 
                value="1" 
                min="1"
                class="product-form__quantity-input"
              >
              <button type="button" class="product-form__quantity-btn" data-action="increase">+</button>
            </div>
          </div>
          
          <input type="hidden" name="id" id="ProductVariantId" value="{{ product.selected_or_first_available_variant.id }}">
          
          <button 
            type="submit" 
            name="add" 
            class="product-form__submit"
            {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
          >
            {% if product.selected_or_first_available_variant.available %}
              Add to Cart
            {% else %}
              Sold Out
            {% endif %}
          </button>
        </form>
        
        {% if product.description != blank %}
          <div class="product-info__description">
            {{ product.description }}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% else %}
  <div class="product-page">
    <div class="product-page__container">
      <p>Product not found.</p>
    </div>
  </div>
{% endif %}

<style>
  .product-page {
    padding: 6rem 0;
    background: #ffffff;
  }

  .product-page__container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6rem;
    align-items: start;
  }

  .product-gallery {
    position: sticky;
    top: 100px;
  }

  .product-gallery__main {
    width: 100%;
    margin-bottom: 2rem;
    border-radius: 12px;
    overflow: hidden;
    background: #f8f8f8;
  }

  .product-gallery__main-image {
    width: 100%;
    height: auto;
    display: block;
    transition: opacity 0.3s ease;
  }

  .product-gallery__placeholder {
    width: 100%;
    aspect-ratio: 1 / 1;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-gallery__thumbnails {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .product-gallery__thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    background: none;
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
  }

  .product-gallery__thumbnail:hover {
    border-color: var(--color-accent);
    transform: scale(1.05);
  }

  .product-gallery__thumbnail.active {
    border-color: var(--color-primary);
  }

  .product-gallery__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .product-info__title {
    font-family: var(--font-heading-family);
    font-size: 3.6rem;
    font-weight: 300;
    margin: 0 0 2rem 0;
    color: var(--color-primary);
    line-height: 1.2;
  }

  .product-info__price {
    margin-bottom: 3rem;
    display: flex;
    align-items: baseline;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .product-info__price-current {
    font-size: 3rem;
    font-weight: 600;
    color: var(--color-accent);
  }

  .product-info__price-compare {
    font-size: 2rem;
    color: rgba(0, 0, 0, 0.5);
    text-decoration: line-through;
  }

  .product-info__price-save {
    font-size: 1.4rem;
    color: #4caf50;
    font-weight: 500;
  }

  .product-info__description {
    margin-bottom: 3rem;
    font-size: 1.6rem;
    line-height: 1.8;
    color: rgba(0, 0, 0, 0.7);
  }

  .product-info__description h1,
  .product-info__description h2,
  .product-info__description h3 {
    font-family: var(--font-heading-family);
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .product-form {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .product-form__variants {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .product-form__option {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .product-form__option-label {
    font-size: 1.6rem;
    font-weight: 500;
    color: var(--color-primary);
  }

  .product-form__option-values {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .product-form__option-input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .product-form__option-value {
    padding: 1rem 2rem;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.4rem;
    transition: all 0.3s ease;
    background: #ffffff;
  }

  .product-form__option-input:checked + .product-form__option-value {
    border-color: var(--color-accent);
    background: var(--color-accent);
    color: #ffffff;
  }

  .product-form__option-value:hover {
    border-color: var(--color-accent);
  }

  .product-form__quantity {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .product-form__quantity-label {
    font-size: 1.6rem;
    font-weight: 500;
    color: var(--color-primary);
  }

  .product-form__quantity-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    width: fit-content;
  }

  .product-form__quantity-btn {
    width: 40px;
    height: 40px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    background: #ffffff;
    border-radius: 8px;
    font-size: 2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary);
  }

  .product-form__quantity-btn:hover {
    border-color: var(--color-accent);
    background: var(--color-accent);
    color: #ffffff;
  }

  .product-form__quantity-input {
    width: 80px;
    height: 40px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    text-align: center;
    font-size: 1.6rem;
    font-weight: 500;
  }

  .product-form__submit {
    padding: 1.8rem 3.2rem;
    background: var(--color-accent);
    color: #ffffff;
    border: none;
    border-radius: 12px;
    font-size: 1.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: var(--font-body-family);
  }

  .product-form__submit:hover:not(:disabled) {
    background: var(--color-primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .product-form__submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (max-width: 990px) {
    .product-page {
      padding: 4rem 0;
    }

    .product-page__container {
      grid-template-columns: 1fr;
      gap: 4rem;
    }

    .product-gallery {
      position: static;
    }

    .product-info__title {
      font-size: 3rem;
    }

    .product-info__price-current {
      font-size: 2.4rem;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Image gallery functionality
    const thumbnails = document.querySelectorAll('.product-gallery__thumbnail');
    const mainImage = document.getElementById('ProductImage');
    
    if (thumbnails.length > 0 && mainImage) {
      thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
          // Update main image
          const newSrc = this.dataset.imageSrc;
          mainImage.src = newSrc;
          
          // Update active state
          thumbnails.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }

    // Quantity controls
    const quantityInput = document.getElementById('Quantity');
    const decreaseBtn = document.querySelector('[data-action="decrease"]');
    const increaseBtn = document.querySelector('[data-action="increase"]');
    
    if (decreaseBtn) {
      decreaseBtn.addEventListener('click', function() {
        const current = parseInt(quantityInput.value);
        if (current > 1) {
          quantityInput.value = current - 1;
        }
      });
    }
    
    if (increaseBtn) {
      increaseBtn.addEventListener('click', function() {
        const current = parseInt(quantityInput.value);
        quantityInput.value = current + 1;
      });
    }

    // Variant selection
    const variantInputs = document.querySelectorAll('.product-form__option-input');
    const variantIdInput = document.getElementById('ProductVariantId');
    
    if (variantInputs.length > 0) {
      variantInputs.forEach(input => {
        input.addEventListener('change', function() {
          updateVariant();
        });
      });
    }

    function updateVariant() {
      const selectedOptions = {};
      variantInputs.forEach(input => {
        if (input.checked) {
          const optionName = input.name.match(/\[(.*?)\]/)[1];
          selectedOptions[optionName] = input.value;
        }
      });

      // Find matching variant using variant data
      const variantData = [
        {% for variant in product.variants %}
        {
          id: {{ variant.id }},
          price: {{ variant.price }},
          priceFormatted: '{{ variant.price | money }}',
          compare_at_price: {{ variant.compare_at_price | default: 0 }},
          compare_at_priceFormatted: {% if variant.compare_at_price %}'{{ variant.compare_at_price | money }}'{% else %}null{% endif %},
          available: {{ variant.available | json }},
          options: {{ variant.options | json }},
          featured_image: {% if variant.featured_image %}'{{ variant.featured_image | image_url: width: 1200 }}'{% else %}null{% endif %}
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ];

      const optionNames = [
        {% for option in product.options %}
        '{{ option.name }}'{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ];

      const matchingVariant = variantData.find(variant => {
        return variant.options.every((option, index) => {
          const optionName = optionNames[index];
          return selectedOptions[optionName] === option;
        });
      });

      if (matchingVariant) {
        variantIdInput.value = matchingVariant.id;
        
        // Update price using pre-formatted values
        const priceElement = document.querySelector('.product-info__price-current');
        if (priceElement && matchingVariant.priceFormatted) {
          priceElement.textContent = matchingVariant.priceFormatted;
        }

        // Update compare at price
        const priceCompare = document.querySelector('.product-info__price-compare');
        const priceSave = document.querySelector('.product-info__price-save');
        
        if (matchingVariant.compare_at_price > matchingVariant.price && matchingVariant.compare_at_priceFormatted) {
          if (priceCompare) {
            priceCompare.textContent = matchingVariant.compare_at_priceFormatted;
            priceCompare.style.display = 'inline';
          }
          if (priceSave) {
            const savings = matchingVariant.compare_at_price - matchingVariant.price;
            const savingsFormatted = (savings / 100).toLocaleString('{{ request.locale.iso_code }}', {
              style: 'currency',
              currency: '{{ cart.currency.iso_code }}',
              minimumFractionDigits: 2
            });
            priceSave.textContent = 'Save ' + savingsFormatted;
            priceSave.style.display = 'inline';
          }
        } else {
          if (priceCompare) priceCompare.style.display = 'none';
          if (priceSave) priceSave.style.display = 'none';
        }

        // Update availability
        const submitBtn = document.querySelector('.product-form__submit');
        if (submitBtn) {
          if (matchingVariant.available) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add to Cart';
          } else {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sold Out';
          }
        }

        // Update image if variant has different image
        if (matchingVariant.featured_image && mainImage) {
          mainImage.src = matchingVariant.featured_image;
          
          // Update thumbnail if it exists
          const matchingThumbnail = document.querySelector(`[data-image-src="${matchingVariant.featured_image}"]`);
          if (matchingThumbnail) {
            thumbnails.forEach(t => t.classList.remove('active'));
            matchingThumbnail.classList.add('active');
          }
        }
      }
    }
  });
</script>
